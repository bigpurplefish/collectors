# Purinamills Product Collector

Collects and enriches product data from Purina Mills websites for Shopify import.

## Overview

This collector retrieves product information from two Purina Mills websites:
- **shop.purinamills.com** - Primary e-commerce site (Shopify)
- **www.purinamills.com** - Secondary information site (fallback)

It uses a 3-tier fallback strategy:
1. Exact match using `description_1` field on shop site
2. Fuzzy match using description_1/upcitemdb_title on shop site
3. Fallback to www site if shop site has no matches

## Features

- Dual-site support with automatic fallback
- Direct site search (no index building required)
- Fuzzy name matching with keyword extraction
- Image quality assessment and selection
- Variant/parent product support
- Thread-safe GUI with queue-based communication
- Automatic retry logic with rate limiting

## Installation

```bash
# Clone or navigate to project
cd /Users/moosemarketer/Code/Python/collectors/purinamills

# Set up virtual environment
pyenv local purinamills

# Install dependencies
pip install -r requirements.txt

# For GUI support
pip install -r requirements-gui.txt

# For development
pip install -r requirements-dev.txt
```

## Usage

### GUI Mode (Recommended)

```bash
python gui.py
```

The GUI provides:
- File selection for input/output
- Progress tracking with status updates
- Configurable processing modes (skip/overwrite)
- Record range selection
- Auto-save configuration

### Command Line

```bash
python main.py --input input/products.xlsx --output output/products.json
```

### Python API

```python
from src.collector import PurinamillsCollector
import requests

collector = PurinamillsCollector()

# Find product URL
product_url = collector.find_product_url(
    upc="123456789012",
    http_get=requests.get,
    timeout=30,
    log=print,
    product_data={"description_1": "Purina Horse Feed"}
)

# Parse product page
enriched_data = collector.parse_page(html_text)
```

## Project Structure

```
purinamills/
├── main.py                 # CLI entry point
├── gui.py                  # GUI entry point
├── src/                    # Application code
│   ├── collector.py        # Main orchestration
│   ├── search.py           # Product search logic
│   └── parser.py           # HTML parsing
├── utils/                  # Project utilities
│   ├── image_quality.py    # Image assessment
│   └── shopify_output.py   # Shopify format generation
├── tests/                  # Test scripts
│   ├── test_workflow.py    # End-to-end tests
│   └── test_variants.py    # Variant tests
├── input/                  # Input files (gitignored)
├── output/                 # Output files (gitignored)
├── logs/                   # Log files (gitignored)
├── docs/                   # Documentation
│   └── CLAUDE.md           # AI assistant guidance
├── requirements.txt        # Production dependencies
├── requirements-dev.txt    # Development dependencies
├── requirements-gui.txt    # GUI dependencies
└── README.md               # This file
```

## Configuration

Site configuration is embedded in `src/collector.py`:

```python
SITE_CONFIG = {
    # Primary shop site
    "shop_origin": "https://shop.purinamills.com",

    # Secondary www site (fallback)
    "www_origin": "https://www.purinamills.com",

    # Search settings
    "max_search_candidates": 10,
    "fuzzy_match_threshold": 0.3,
    "fetch_jitter_min_ms": 200,
    "fetch_jitter_max_ms": 700,
}
```

User settings (file paths, etc.) are stored in `config.json` (auto-generated by GUI).

## Input Format

Excel file (.xlsx) with columns:
- `upc` - Product UPC/barcode
- `description_1` - Product name (exact match preferred)
- `upcitemdb_title` - Alternative name for fuzzy matching
- `parent_upc` - For variant products (optional)

## Output Format

Shopify-compatible JSON with:
- All original input fields preserved
- `manufacturer` object with enriched product data
- `shopify.media` array with image filenames
- Support for parent/variant structure

## Development

### Running Tests

```bash
# End-to-end workflow test
python tests/test_workflow.py

# Variant structure test
python tests/test_variants.py

# Search functionality test
python tests/test_www_search.py
```

### Code Quality

```bash
# Format code
black src/ utils/ tests/

# Lint code
flake8 src/ utils/ tests/

# Type check
mypy src/
```

## Architecture

### Core Components

- **collector.py** - Main orchestration layer, coordinates search and parsing
- **search.py** - Implements 3-tier search strategy across both sites
- **parser.py** - Dual-site HTML parsing with auto-detection
- **image_quality.py** - Image quality assessment using Laplacian variance
- **shopify_output.py** - Shopify JSON format generation

### Data Flow

1. Load products from Excel input file
2. For each product:
   - Search for product URL (shop site → www site)
   - Fetch and parse product page
   - Extract variants if parent product
   - Assess and select best images
   - Generate Shopify output structure
3. Write enriched products to JSON output

### Shared Dependencies

Imports utilities from `../shared/`:
- `text_only()` - HTML entity decoding
- `load_products()` - Excel file loading
- HTTP utilities, image processing helpers

## Notes

- Input file `description_1` field should contain exact product names for best results
- Fuzzy matching uses keyword extraction with synonyms (equine→horse, bovine→cattle)
- Rate limiting prevents overwhelming the servers
- Images are normalized to HTTPS with query params stripped
- Placeholder images are detected and filtered out

## License

Internal tool - Not for public distribution

## Support

For issues or questions, contact the development team.
